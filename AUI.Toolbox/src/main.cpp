#include <filesystem>
#include <functional>
#include <iostream>
#include <AUI/IO/APath.h>


#include "AUI/Common/AString.h"
#include "AUI/Common/AStringVector.h"
#include "AUI/Common/ByteBuffer.h"
#include "AUI/Common/AMap.h"
#include "AUI/IO/FileInputStream.h"
#include "AUI/IO/FileOutputStream.h"
#include "AUI/Util/BuiltinFiles.h"
#include "AUI/Util/LZ.h"

void printHelp()
{
	std::cout << "Available commands:" << std::endl
		<< "\tpack <dir> <dst>\t\tpack a dir into the .h file";
	exit(-1);
}

int main(int argc, char** argv)
{	
	std::cout << "Alex2772 Universal Interface toolbox" << std::endl;
	if (argc <= 1)
	{
		printHelp();
	}
	else
	{
		AStringVector args;
		for (int i = 2; i < argc; ++i)
		{
			args << argv[i];
		}

		AMap<AString, std::function<void()>> commands = {
			{
				"pack", [&]()
				{
					if (args.size() != 2)
					{
						printHelp();
					}
					else
					{
					    try {
					        APath(args[1].toStdString()).removeFileRecursive();
                        } catch (...) {

                        }
						unsigned index = 0;
						try
						{
							for (auto& entry : std::filesystem::recursive_directory_iterator(args[0].toStdString()))
							{
							    ++index;
								if (entry.is_regular_file()) {
									try
									{
                                        ByteBuffer buffer;
										AString filePath = AString::path(entry.path());
										filePath = filePath.mid(args[0].length() + 1);
										filePath = filePath.replaceAll("\\", '/');

										buffer << filePath.toStdString();
										auto fis = _new<FileInputStream>(AString::path(entry.path()));

										ByteBuffer data;

										char buf[4096];
										for (int r; (r = fis->read(buf, sizeof(buf))) > 0;)
										{
											data.put(buf, r);
										}
										buffer << uint32_t(data.getSize());
										buffer << data;

										ByteBuffer packed;
										LZ::compress(buffer, packed);


                                        uint32_t hash = std::hash<AString>()(args[0] + args[1]) ^ index;

                                        auto path = std::filesystem::path(args[1].toStdString())
                                                .concat(("/assets" + AString::number(hash) + ".cpp")
                                                .toStdString());

                                        AString name(path);

                                        auto out = _new<FileOutputStream>(name);
                                        *out << AString(
                                                "// This file is autogenerated by AUI.Toolkit. Please do not modify.\n");
                                        *out << AString(
                                                "\n"
                                                "#include \"AUI/Common/ByteBuffer.h\"\n"
                                                "#include \"AUI/Util/BuiltinFiles.h\"\n");
                                        *out << AString("const static unsigned char AUI_PACKED_asset") << AString::number(hash) << AString("[] = {");
                                        for (uint8_t c : packed) {
                                            char buf[32];
                                            sprintf(buf, "0x%02x,", c);
                                            *out << AString(buf);
                                        }
                                        *out << AString("};\n");

                                        *out << AString("struct Assets" + AString::number(hash) + " {\n"
                                                                                                  "\tAssets" + AString::number(hash) + "(){\n"
                                                                                                                                       "\t\tBuiltinFiles::load(AUI_PACKED_asset" +
                                                        AString::number(hash) +
                                                        ", sizeof(AUI_PACKED_asset" +
                                                        AString::number(hash) + "));\n\t}\n};\n"
                                                                                "static Assets" + AString::number(hash) +
                                                        " a" + AString::number(hash) + ";");
                                        out = nullptr;
                                        std::cout << filePath << " -> " << path
                                                  << std::endl;
									}
									catch (std::exception& e)
									{
										std::cout << "Warning: could not read file " << entry.path() << ": " << e.what() << std::endl;
									}
									catch (AException& e)
									{
										std::cout << "Warning: could not read file " << entry.path() << ": " << e.getMessage().toStdString() << std::endl;
									}
								}
							}

						}
						catch (...)
						{
							std::cout << "Could not open directory: " << std::filesystem::absolute(args[0].toStdString()) << std::endl;
							exit(-2);
						}
					}
				},

			}
		};
		if (auto c = commands.contains(argv[1]))
		{
			c->second();
		}
		else
		{
			printHelp();
		}
	}

	return 0;
}
